<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <title>Table Translit</title>
  <style>
      :root {
        --ln: #ccd;
        --fn: #aab;
      }
      body { margin: 4px; }
      .main {
        width: calc(100vw - 8px);
        height: calc(100vh - 8px);
        border: 1px solid var(--ln);
        overflow: auto;
        outline: none;
        user-select: none;
        cursor: pointer;
        box-sizing: border-box;
      }
      table {
        border-collapse: collapse;
        font: normal 14px monospace;
        -webkit-transition: background-color, filter .4s ease;
        transition: background-color, filter .4s ease;
      }
      tr[cmp] {
        background-color: rgba(250,100,0,.3);
      }
      td {
        padding: 4px 6px;
        margin: 0;
        border-bottom: 1px solid var(--ln);
      }
      td:first-child {
        color: var(--fn);
        text-align: right;
        border-right: 1px solid var(--ln);
      }
      td:last-child { border-right: 1px solid var(--ln); }
.cln1 td:nth-child(3) {
        border-left: 1px solid var(--ln);
        padding-left: 12px;
}
.cln2 td:nth-child(4) {
        border-left: 1px solid var(--ln);
        padding-left: 12px;
}
.cln3 td:nth-child(5) {
        border-left: 1px solid var(--ln);
        padding-left: 12px;
}

  .catHead {
    font-weight: bold;
    font-size: 24px;
    background-color: var(--ln);
    cursor: pointer;
    user-select: none;
  }
  .preCatHead {
    font-weight: bold;
    font-size: 24px;
    background-color: var(--ln);
    text-align: center;
  }
  .hint {
    position: absolute;
    top: calc(100vh / 2 - 62px); left: 20%; width: 60%;
    font: italic 18px sans-serif;
    color: var(--fn);
    text-align: center;
    /*margin: calc(100vh / 2 - 42px) 20% 0 20%;*/
    display: block;
    z-index: -2;
  }

.setting_panel {
  box-sizing: border-box;
  position: absolute;
  z-index: 100;
  top: calc(-100vh - 13px);
  right: 0px;
  max-width: 280px;
  border: 1px solid var(--ln);
  background-color: #fff;
  box-shadow: 0px 3px 10px #000;
  max-height: 100vh;
  overflow-y: auto;
  scrollbar-width: none;
  -webkit-transition: top .4s ease;
  transition: top .4s ease;
}
.setting_panel::-webkit-scrollbar {  display: none; }

.set_item {
  box-sizing: border-box;
  border-bottom: 1px solid var(--ln);
  width: 100%;
  white-space: nowrap;
  padding: 12px 4px;
  text-align: center;
  font-family: Arial,sans-serif;
}
.set_item div {
	font-size: 14px;
  padding: 4px 8px;
  height: 20px;
  display: inline-block;
  cursor: pointer;
  vertical-align: middle;
  border-radius: 6px;
  user-select: none;
}
.set_item div[selected] {
	background-color: #6a6;
  color: #fff;
}
.set_item span {
	font-size: 12px;
  color: #6a6;
  display: block;
  margin-bottom: 10px;
}
.set_item i { font-size: 18px; margin-right: 8px;}
.rBut {
    box-sizing: border-box;
    width: 14px;
    padding-top: 10px;
    height: 40px;
    position: fixed;
    top: calc(100vh / 2 - 30px);
    background-color: #88a;
    opacity: .5;
    border-radius: 14px 0 0 14px;
    font-size: 20px; color: #fff;
    text-align: right;
    right: 0px;
    z-index: 101;
}
.lBut {
    box-sizing: border-box;
    width: 14px;
    padding-top: 10px;
    height: 40px;
    position: fixed;
    top: calc(100vh / 2 - 30px);
    background-color: #88a;
    opacity: .5;
    border-radius: 0 14px 14px 0;
    font-size: 20px; color: #fff;
    left: 0px;
    z-index: 101;
}
.zvic { animation: zvic-anim .6s 1; }
@keyframes zvic-anim {
  0% { -webkit-transform: scale(1); transform: scale(1); }
  50% { -webkit-transform: scale(2.4); transform: scale(2.4); }
  100% { -webkit-transform: scale(1); transform: scale(1); }
}

.score {
  position: absolute;
  right: 0px;
  top: -140px;
  color: #dde;
  font: bold 130px Arial, sans-serif;
  display: inline-block;
  -webkit-transform-origin: right bottom;
  transform-origin: right bottom;
  -webkit-transform: rotate(-90deg);
  transform: rotate(-90deg);
  z-index: -1;
}
.toast {
  font: normal 24px Arial, sans-serif;
  padding: 18px 28px;
  position: absolute;
  left: 50%;
  transform: translate(-50%, 0);
  top: -100vh;
  text-align: center;
  background-color: rgb(0,0,0,.5);
  color: #fff;
  border-radius: 12px;
  white-space: nowrap;
  z-index: 33;
  transition: top .3s ease;
}
  </style>
</head>
<body>

<div class="score"></div>

<div class="setting_panel">
<div class="set_item">
  <span>Sort the list:</span>
  <div name="sort"><i class="fa fa-sort-alpha-asc"></i>Asc</div>
  <div name="sort"><i class="fa fa-sort-alpha-desc"></i>Desc</div>
  <div name="sort" selected><i class="fa fa-times-circle"></i>None</div>
</div>
<div class="set_item">
  <span>Show first:</span>
  <div name="show" selected><i class="fa fa-pencil"></i>Cyrillic</div>
  <div name="show"><i class="fa fa-pencil-square-o"></i>Latin/English</div>
</div>
<div class="set_item">
  <span>Show unique items:</span>
  <div name="unique"><i class="fa fa-flag-checkered"></i>Unique only</div>
  <div name="unique" selected><i class="fa fa-repeat"></i>Incl. repeated</div>
</div>
<div class="set_item">
  <span>Show first:</span>
  <div name="fName" selected><i class="fa fa-list"></i>Name</div>
  <div name="fName"><i class="fa fa-table"></i>Surname (family)</div>
</div>
<div class="set_item">
  <span>Sample (Name, Middle, Surname):</span>
  <div name="data"><i class="fa fa-list-ol"></i>Name</div>
  <div name="data"><i class="fa fa-columns"></i>Nm+SrNm</div>
  <div name="data"><i class="fa fa-table"></i>Full</div>
</div>
<div class="set_item">
  <span>Show as catalogue:</span>
  <div name="catal"><i class="fa fa-list"></i>Catalogue</div>
  <div name="catal" selected><i class="fa fa-table"></i>Table</div>
</div>
<div class="set_item" style="border:none">
  <span>Download the lists:</span>
  <div name="down"><i class="fa fa-download"></i>Download</div>
  <div name="down" selected><i class="fa fa-trash"></i>Clear</div>
</div>
</div>

<div class="lBut" onclick="inScene(0)"><i class="fa fa-caret-right"></i></div>
<div class="rBut" onclick="inScene(1)"><i class="fa fa-caret-left"></i></div>

<div class="main" contenteditable="true" onclick="outMenu(this)"><table onclick="outMenu(this)"></table></div>

<span class="hint">Paste here the lists in Cyrillic and Latin/English transcription, in whatever order...<br><br><i class="fa fa-arrow-left"></i> or use the buttons <i class="fa fa-arrow-right"></i></span>

<div class='toast'><i class="fa fa-exclamation-triangle" style="color:#ff0;"></i> <span></span></div>

<pre id="pre_cyr" style="display:none">
Александр Васильевич Александров
Данила Илларионович Татаров
Елена Ивановна Николаева
Алексей Ильич Васнецов
Евгений Петрович Крылов
Кирилл Алексеевич Татаров
Анна Ивановна Селезнёва
Ксения Владимировна Иванова
Мариянна Петровна Ким
Изя Марковна Гинзбург
Сергей Ильич Васнецов
Никита Илларионович Крылов
Алексей Ильич Васнецов
Наталья Ивановна Николаева
Мария Владимировна Иванова
Андрей Алексеевич Татаров
Артём Петрович Крылов
Ольга Ивановна Селезнёва
Александра Петровна Иванова
Дмитрий Васильевич Александров
Иван Илларионович Серов
Алексей Ильич Васнецов
Светлана Петровна Николаева
Софья Владимировна Ким
Михаил Петрович Крылов
Пётр Ильич Васнецов
Юлия Ивановна Селезнёва
Дарья Владимировна Серова
Павел Васильевич Татаров
Магомед Каримович Дудаев
Егор Илларионович Александров
Мария Петровна Иванова
Анастассия Владимировна Николаева
Полина Владимировна Серова
Илья Алексеевич Крылов
Матвей Ильич Васнецов
Ирина Петровна Николаева
Елизавета Ивановна Иванова
Константин Илларионович Татаров
Максим Петрович Васнецов
Екатерина Петровна Иванова
Валерия Владимировна Николаева
Виктор Васильевич Крылов
Григорий Ильич Васнецов
Татьяна Ивановна Селезнёва
Екатерина Владимировна Ким
</pre>
<pre id="pre_lat" style="display:none">
Sofia Vladimirovna Kim
Mikhail Petrovich Krylov
Petr Ilyich Vasnetsov
Yulia Ivanovna Selezneva
Daria Vladimirovna Serova
Pavel Vasilievich Tatarov
Egor Illarionovich Aleksandrov
Maria Petrovna Ivanova
Polina Vladimirovna Serova
Ilya Alekseevich Krylov
Matvey Ilyich Vasnetsov
Aleksandr Vasilievich Aleksandrov
Danila Illarionovich Tatarov
Elena Ivanovna Nikolaeva
Anastasia Vladimirovna Nikolaeva
Aleksey Ilyich Vasnetsov
Yevgeniy Petrovich Krylov
Kirill Alekseevich Tatarov
Anna Ivanovna Selezneva
Ksenia Vladimirovna Ivanova
Maryanna Petrovna Kim
Sergei Ilyich Vasnetsov
Nikita Illarionovich Krylov
Anastasia Vladimirovna Nikolaeva
Ibrahim Ahmatovich Karamazin
Natalya Ivanovna Nikolaeva
Maria Vladimirovna Ivanova
Aleksey Ilyich Vasnetsov
Andrey Alekseevich Tatarov
Artem Petrovich Krylov
Irina Petrovna Nikolaeva
Elizaveta Ivanovna Ivanova
Konstantin Illarionovich Tatarov
Maksim Petrovich Vasnetsov
Ekaterina Petrovna Ivanova
Valeria Vladimirovna Nikolaeva
Viktor Vasilievich Krylov
Aleksey Ilyich Vasnetsov
Grigorii Ilyich Vasnetsov
Tatiana Ivanovna Selezneva
Ekaterina Vladimirovna Kim
Olga Ivanovna Selezneva
Aleksandra Petrovna Ivanova
Dmitriy Vasilievich Aleksandrov
Ivan Illarionovich Serov
Svetlana Petrovna Nikolaeva
</pre>

<script>

const Cmp = {
  cyr: null,
  lat: null,
  len: 0
}

const Trans = [
['ья', '(ya|ia|iya)'],
['ье', '(ie|e|ye)'],
['ьи', '(yi|i)'],
['ай', '(ay|ai)'],
['ой', '(oy|oi)'],
['ий', '(iy|ii)'],
['уй', '(uy|ui)'],
['ый', '(yy|yi)'],
['эй', '(ey|yey)'],
['юй', '(yuy|yui)'],
['ей', '(ey|yey|ei)'],
['ия', '(ia|iya|ya)'],

['а','a'],['б','b'],['в','v'],['г','g'],['д','d'],
['е','e'],['ё','e'],['ж','zh'],['з','z'],['и','i'],
['й','i'],['к','k'],['л','l'],['м','m'],['н','n'],
['о','o'],['п','p'],['р','r'],['с','s'],['т','t'],
['у','u'],['ф','f'],['х','kh'],['ц','ts'],['ч','ch'],
['ш','sh'],['щ','shsh'],['ъ','ie'],['ы','y'],['ь',''],
['э','e'],['ю','yu'],['я','ya']
];

function dispatch() {
  if(!Cmp.cyr && !Cmp.lat) return;
  if(!Cmp.cyr) makeTable(Cmp.lat);
  else if(!Cmp.lat) makeTable(Cmp.cyr);
  else process(Cmp.cyr, Cmp.lat);
}

var rmvSpan = true;

function makeTable(rs) {
  if(rmvSpan) {
    document.querySelector('.hint').style.display = 'none';
    rmvSpan = false;
  }
  let T = document.querySelector('table'), Cnt = 1;
  while(T.rows.length > 0) T.deleteRow(0);
  T.className = `cln${Cmp.len}`;

  rs.forEach(r => {
    let R = T.insertRow();
    if(r.charAt(0) == '>') {
      R.setAttribute('cmp','');
      r = r.substr(1);
    }
    let cs = r.split(' ');
    R.insertCell().innerText = Cnt++;
    cs.forEach(c => R.insertCell().innerText = c);
  });
}

document.addEventListener('paste', (event) => {
  let pst = (event.clipboardData || window.clipboardData).getData('text').trim();
  event.preventDefault();
  if(pst == '') return;
  if(chNorm(pst)) dispatch();
  document.querySelector('.main').blur();
  document.querySelector('table').blur();
});

function chNorm(txt) {
  let tip;
  if(/^[А-ЯЁа-яё\s\-]+$/.test(txt)) tip = 'C';
  else if(/^[A-Za-z\s\-]+$/.test(txt)) tip = 'L';
  else { toast('Wrong format'); return false; }

  let splitChar = /\s+/, arr = [], clmns = -1;
  txt.split('\n').forEach(el => {
    if((el = el.trim()) =='') return;
    let w = el.split(splitChar);
    if(clmns < 0) clmns = w.length;
    if(w.length != clmns) { toast('Wrong columns'); return false; }
    arr.push(w.join(' '));
  });
  if(tip == 'C') Cmp.cyr = arr; else Cmp.lat = arr;
  return true;
}

function process(cyr, lat) {
    let cnt = 0;
    /*cyr = cyr.map(el => el.trim()); lat = lat.map(el => el.trim());
    if(cyr.findIndex(el => el == '') > -1) cyr = cyr.filter(el => el != '');
    if(lat.findIndex(el => el == '') > -1) lat = lat.filter(el => el != '');*/

    cyr = [...cyr]; lat = [...lat];

    if(Setts.unique == 0) { cyr = [...new Set(cyr)]; lat = [...new Set(lat)]; }

    Cmp.len = cyr[0].split(' ').length;
    const prts = ' '.repeat(Cmp.len), lookE = /^e| e/g;

    for(let i in cyr) {
      let w = cyr[i].toLowerCase();
      Trans.forEach(lit => {if(w.includes(lit[0])) w = w.replaceAll(lit[0],lit[1]);});

      if(lookE.test(w)) if((w = w.replace(lookE, ' (ye|e)')).charAt(0)==' ') w = w.slice(1);

      Rx = new RegExp('^'+ w + '$','i');
      let ix = lat.findIndex(val => Rx.test(val));
      if(ix < 0) {
        cyr[i] = Setts.show == 0 ? '>' + cyr[i] + prts : '>' + prts + cyr[i];
        cnt++;
      }
      else {
        cyr[i] = Setts.show == 0 ? cyr[i] + ' ' + lat[ix] : lat[ix] + ' ' + cyr[i];
        lat[ix] = '>' + lat[ix];
      }
    }
  lat = lat.filter(el => el.charAt(0)!='>'); cnt += lat.length;
  cyr = cyr.concat(lat.map(el => Setts.show == 0 ? '>' + prts + el : '>' + el + prts));

  if(Setts.catal == 0) makeCatalogue(cyr);
  else {
    if(Setts.sort < 2) { cyr.sort(); if(Setts.sort == 1) cyr.reverse(); }
    makeTable(cyr);
  }  
  document.querySelector(".score").innerText = 100 - Math.floor(cnt/cyr.length*100) + '%';
}

function makeCatalogue(rs) {
  rs = rs.sort((a,b)=>{
    if(a.charAt(0)!='>' && b.charAt(0)!='>') return a.localeCompare(b);
    let A = a.charAt(0)!='>'?a:a.substr(1), B = b.charAt(0)!='>'?b:b.substr(1);
    return (A.charAt(0)==' ' || B.charAt(0)==' ')?B.localeCompare(A):A.localeCompare(B);
  });
  if(rmvSpan) {
    document.querySelector('.hint').style.display = 'none';
    rmvSpan = false;
  }
  let T = document.querySelector('table'), Cnt = 1;
  while(T.rows.length > 0) T.deleteRow(0);
  T.className = `cln${Cmp.len}`;
  
  let cmp, lttr, fl = false, lst;
  insCatHead(T, 'ALL', null, true);

  rs.forEach((r,ix) => {
    if(r.charAt(0) == '>') { r = r.substr(1); cmp = true; }
    else cmp = false;
    if(ix == 0) {
      lttr = r.charAt(0);
      lst = insCatHead(T, lttr, fl?lst:null);
      fl = false;
    }   
    let cs = r.split(' '), A = cs[0].charAt(0);
    if(lttr != A) {
      lst = insCatHead(T, A, fl?lst:null);
      lttr = A;
      fl = false;
    }  
    let R = T.insertRow();
    R.insertCell().innerText = Cnt++;
    R.style.display = 'none';

    cs.forEach(c => {
      R.insertCell().innerText = c;
      if(cmp) { R.setAttribute('cmp',''); fl = true; }
    });
  });
  if(fl) lst.style.backgroundColor = '#fb6';
}

function insCatHead(T, A, lst, ifAll = false) {
  if(lst) lst.style.backgroundColor = '#fb6';
	let R = T.insertRow();
  let c = R.insertCell(); c.innerText = '+'; c.className = 'preCatHead';
  c = R.insertCell(); c.innerText = A;
  if(ifAll) {
    c.addEventListener('click', () => { ExpandAll(); });
    c.setAttribute('clps', '0');
  }
  else c.addEventListener('click', (event) => { Expand(event.target); });
  c.className = 'catHead';
  //c.setAttribute('contenteditable','false');
  return c;
}

function Expand(nx) {
	let lttr = nx.innerText.charAt(0), ln = nx.parentElement, prv = nx.previousElementSibling;
  prv.innerText = prv.innerText == '+'?'-':'+';
    while(true) {
    	nx = ln.nextElementSibling;
        if(!nx || nx.cells[1].innerText.charAt(0) != lttr) break;
        if(nx.style.display = nx.style.display != 'none'?'none':'table-row');
        ln = nx;
    }
}

function ExpandAll() {
  let rs = document.querySelector('table').rows, L = rs.length, aTd = rs[0].cells[1];
  let clps = aTd.getAttribute('clps');
  clps = clps == '0'?'1':'0';
  aTd.setAttribute('clps', clps);
  aTd = aTd.previousElementSibling;
  aTd.innerText = clps == '1'?'-':'+';
  for(let i=1; i<L; i++) {
    let cl = rs[i].cells[1], st = rs[i].style;
    if(cl.classList.contains("catHead")) {
      let prv = cl.previousElementSibling;
      prv.innerText = clps == '1'?'-':'+';
    }
    if(!cl.classList.contains("catHead"))
    st.display = clps == '1'?'table-row':'none';
  }
}

function clearAll() {
  let T = document.querySelector('table');
  while(T.rows.length > 0) T.deleteRow(0);
  document.querySelector('.hint').style.display = 'block';
  document.querySelector(".score").innerText = '';
  rmvSpan = true;
  Cmp.cyr = ''; Cmp.lat = '';
}

const Setts = {
	sort: 2,
  unique: 1,
  show: 0,
  fName: 0,
  data: -1,
  down: 1,
  catal: 1
}

document.querySelectorAll('.set_item div').forEach(e => e.addEventListener("click", function(e) {
	let attr = 'selected', el = e.target, nm = el.getAttribute('name');
  document.getElementsByName(nm).forEach((e,i)=>{
    if(e == el) { e.setAttribute(attr,''); Setts[nm] = i; }
    else if(e.hasAttribute(attr)) e.removeAttribute(attr);
  });
  inScene(0);
  if(nm == 'data' || nm == 'fName') { sampleData(); dispatch(); }
  else if(nm == 'down') {
    if(Setts.down == 0) fetchAll();
    else clearAll();
  }
  else dispatch();
}, false));

function confLine(e) {
  let tip = Setts.data, fn = Setts.fName;
  if(tip==0) return e.split(' ')[fn?2:0];
  if(tip==1) return fn? `${(e=e.split(' '))[2]} ${e[0]}`: `${(e=e.split(' '))[0]} ${e[2]}`;
  if(tip==2) return fn?`${(e=e.split(' '))[2]} ${e[0]} ${e[1]}`:e;
  return `${(e=e.split(' '))[2].toUpperCase()} ${e[0]} ${e[1]}`;
}

function sampleData() {
  if(Setts.data < 0) return;
  Cmp.cyr = document.getElementById("pre_cyr").innerText.trim().split('\n').map(confLine);
  Cmp.lat = document.getElementById("pre_lat").innerText.trim().split('\n').map(confLine);
}

function inScene(lr) {
  let p = document.querySelector(".setting_panel"),
    fonSt = document.querySelector("table").style;
  if(p.style.top && p.style.top == '0px') {
    p.style.top = `-${stPnlSt.scrollHeight + 13}px`;
    fonSt.backgroundColor = null;
    fonSt.filter = null;
    return;
  }
  if(lr) {
    if(p.style.left) p.style.left = null;
    p.style.right = '0px';
  }
  else {
    if(p.style.right) p.style.right = null;
    p.style.left = '0px';
  }
  p.style.top = '0px';
  fonSt.backgroundColor = '#ddd';
  fonSt.filter = 'blur(1.4px)';
}

function fetchAll() {
  Promise.all([
    fetch('cyr.txt').then(res => { return res.text().then(txt => Cmp.cyr = txt.split('\n') )}),
    fetch('lat.txt').then(res => { return res.text().then(txt => Cmp.lat = txt.split('\n') )})
  ])
  .then(() => dispatch())
  .catch(err => toast(err));
}

function zvic(e) {
    let el = e.target;
    while(el.tagName != 'DIV') el = el.parentElement;
    el.classList.remove("zvic");
    void el.offsetWidth;
    el.classList.add("zvic");
}
document.querySelector('.lBut').addEventListener("click", zvic, false);
document.querySelector('.rBut').addEventListener("click", zvic, false);

function outMenu(obj) {
  let st = document.querySelector(".setting_panel").style;
  if(st.top && st.top == '0px') inScene(0);
  obj.blur();
}
function toast(txt, opn = true) {
	let T = document.querySelector('.toast');
	if(opn) {
	    T.querySelector('span').innerText = txt;
	    T.style.top = '60px';
	}
	else T.style.top = `-${T.getBoundingClientRect().height}px`;
	if(opn) setTimeout( function() { toast(null, false); }, 1200);
}

const stPnlSt = document.querySelector(".setting_panel");
stPnlSt.style.top = `-${stPnlSt.scrollHeight + 13}px`; stPnlSt.style.display = 'block'; 
  </script>
  </body>
</html>
