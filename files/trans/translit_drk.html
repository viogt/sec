<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link id='curStyle' rel="stylesheet" href="translit_1.css">
    <style>
      #dshRct {
        display: none;
        z-index: 140;
      }
      #dshRct div {
        border: 1px dashed red;
        position: absolute;
      }
    #drop1 {
        top: 0; left: 0; width: 100vw; height: 80px;
        white-space: nowrap;
    }
    #drop2 {
        top: 0; left: calc(100vw - 80px); width: 80px; height: 100vh;
        white-space: normal;
    }
    #drop3 {
        top: calc(100vh - 80px); left: 0; width: 100vw; height: 80px;
        white-space: nowrap;
    }
    #drop4 {
        top: 0; left: 0; width: 80px; height: 100vh;
        white-space: normal;
    }
    </style>
    <title>✎ Translit</title>
  </head>
<body>

<div id='smRed' class="fix_panel panel1" draggable='true'>
<div class="font1" onclick="sampleData(0)">
    <i class="fa fa-download"></i>
    <label>Sample<br>data</label>
</div>
<div class="font1" onclick="matchTrans()">
    <i class="fa fa-check-circle"></i>
    <label>Check<br>translit.</label>
</div>
<div class="font1" onclick="clearData()">
    <i class="fa fa-times-circle"></i>
    <label>Clear<br>data</label>
</div>
<div class="font1" onclick="showMatch()">
    <i class="fa fa-info-circle"></i>
    <label>Show<br>match</label>
</div>
<div class="font1" onclick="matchTrans(true)">
    <i id="sortIcon" class="fa fa-sort-alpha-asc"></i>
    <label>Sort<br>the lists</label>
</div>
<div class="font1" onclick="sampleData(1)">
    <i class="fa fa-upload"></i>
    <label>Sample<br>full data<small><sup>1</sup></small></label>
</div>
<div class="font1" onclick="sampleData(2)">
    <i class="fa fa-cloud-upload"></i>
    <label>Sample<br>full data<small><sup>2</sup></small></label>
</div>
<div class="font1" onclick="showNumber(true)">
    <i class="fa fa-archive"></i>
    <label>Simulate<br>big data<small><sup>3</sup></small></label>
</div>
<div class="font1" onclick="initPos(0)">
    <i id="menuSize" class="fa fa-retweet"></i>
    <label>Menu<br>position</label>
</div>
<div class="font1" onclick="uniqueSet(this)">
    <i class="fa fa-flag-checkered"></i>
    <label>Uniques<br>Set OFF</label>
</div>
<div class="font1" onclick="duotone()">
    <i class="fa fa-adjust"></i>
    <label>Duotone<br>or colour</label>
</div>
<div class="font1" onclick="chTheme()">
    <i class="fa fa-picture-o"></i>
    <label>Change<br>theme</label>
</div>
<div class="font1" onclick="toSite('translit.html')">
    <i class="fa fa-sun-o"></i>
    <label>Light<br>theme</label>
</div>
<div class="font1" onclick="toSite('translit_smpl.html')">
    <i class="fa fa-table"></i>
    <label>Simple<br>table</label>
</div>
<div class="font1" onclick="moreInfo(true)">
    <i class="fa fa-wrench"></i>
    <label>Translit.<br>rules</label>
</div>
<div class="font1" onclick="toScene(true)">
    <i class="fa fa-video-camera"></i>
    <label>Launch<br>demo</label>
</div>
</div>

<pre id="pre_cyr">
Александр Васильевич Александров
Данила Илларионович Татаров
Елена Ивановна Николаева
Алексей Ильич Васнецов
Евгений Петрович Крылов
Кирилл Алексеевич Татаров
Анна Ивановна Селезнёва
Ксения Владимировна Иванова
Мариянна Петровна Ким
Изя Марковна Гинзбург
Сергей Ильич Васнецов
Никита Илларионович Крылов
Наталья Ивановна Николаева
Мария Владимировна Иванова
Андрей Алексеевич Татаров
Артём Петрович Крылов
Ольга Ивановна Селезнёва
Александра Петровна Иванова
Дмитрий Васильевич Александров
Иван Илларионович Серов
Светлана Петровна Николаева
Софья Владимировна Ким
Михаил Петрович Крылов
Пётр Ильич Васнецов
Юлия Ивановна Селезнёва
Дарья Владимировна Серова
Павел Васильевич Татаров
Магомед Каримович Дудаев
Егор Илларионович Александров
Мария Петровна Иванова
Анастассия Владимировна Николаева
Полина Владимировна Серова
Илья Алексеевич Крылов
Матвей Ильич Васнецов
Ирина Петровна Николаева
Елизавета Ивановна Иванова
Константин Илларионович Татаров
Максим Петрович Васнецов
Екатерина Петровна Иванова
Валерия Владимировна Николаева
Виктор Васильевич Крылов
Григорий Ильич Васнецов
Татьяна Ивановна Селезнёва
Екатерина Владимировна Ким
</pre>
<pre id="pre_lat">
Sofia Vladimirovna Kim
Mikhail Petrovich Krylov
Petr Ilyich Vasnetsov
Yulia Ivanovna Selezneva
Daria Vladimirovna Serova
Pavel Vasilievich Tatarov
Egor Illarionovich Aleksandrov
Maria Petrovna Ivanova
Polina Vladimirovna Serova
Ilya Alekseevich Krylov
Matvey Ilyich Vasnetsov
Aleksandr Vasilievich Aleksandrov
Danila Illarionovich Tatarov
Elena Ivanovna Nikolaeva
Anastasia Vladimirovna Nikolaeva
Aleksey Ilyich Vasnetsov
Yevgeniy Petrovich Krylov
Kirill Alekseevich Tatarov
Anna Ivanovna Selezneva
Ksenia Vladimirovna Ivanova
Maryanna Petrovna Kim
Sergei Ilyich Vasnetsov
Nikita Illarionovich Krylov
Ibrahim Ahmatovich Karamazin
Natalya Ivanovna Nikolaeva
Maria Vladimirovna Ivanova
Andrey Alekseevich Tatarov
Artem Petrovich Krylov
Irina Petrovna Nikolaeva
Elizaveta Ivanovna Ivanova
Konstantin Illarionovich Tatarov
Maksim Petrovich Vasnetsov
Ekaterina Petrovna Ivanova
Valeria Vladimirovna Nikolaeva
Viktor Vasilievich Krylov
Grigorii Ilyich Vasnetsov
Tatiana Ivanovna Selezneva
Ekaterina Vladimirovna Kim
Olga Ivanovna Selezneva
Aleksandra Petrovna Ivanova
Dmitriy Vasilievich Aleksandrov
Ivan Illarionovich Serov
Svetlana Petrovna Nikolaeva
</pre>
<div class='txt_area area1'>
    <textarea class="bk" id="cyr" wrap="off" placeholder="Paste Cyrillic here"></textarea>
    <textarea class="bk" id="lat" wrap="off" placeholder="Paste transcript here"></textarea>
    <textarea class="x_bk" id="unMatch" wrap="off" readonly placeholder="Mismatched result"></textarea>
</div>
<div class='pregToast'><i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;<span></span></div>
<div class='infoPad'>
    <i class="fa fa-times cancelIcon" onclick="moreInfo(false)"></i>
    <div class="infoPadTitle"><big><i class="fa fa-wrench"></i></big>&nbsp;&nbsp;Translit. rules:</div>
    <code></code>
    <div class="infoPadTitle"><big><i class="fa fa-info-circle"></i></big>&nbsp;&nbsp;Useful links:</div>
    <ul>
        <li><a target="_blank" href="https://en.wikipedia.org/wiki/Romanization_of_Russian">https://en.wikipedia.org/wiki/Romanization_of_Russian</a></li>
        <li><a target="_blank" href="http://transliteration.ru/mvd_1047/">http://transliteration.ru/mvd_1047/</a></li>
        <li><a target="_blank" href="https://enguide.ru/magazine/angliyskaya-transliteraciya-russkih-fio">https://enguide.ru/magazine/angliyskaya-transliteraciya-russkih-fio</a></li>
    </ul>
</div>
<div class='scene'>
    <i class="fa fa-play" onclick='toScene(true)'></i>
    <i class="fa fa-stop" onclick='toScene(false)'></i>
</div>

<div class="showNumber"><div>
  <div style="font-size:16px">For how many items:</div>
  <input id='numNames' type="text" value="4000"/>
  &nbsp;<i class="fa fa-check" onclick='getNumber()'></i>
  &nbsp;<i class="fa fa-times" onclick='showNumber(false)'></i>
</div></div>

<div id='dshRct'>
  <div id="drop1"></div>
  <div id="drop2"></div>
  <div id="drop3"></div>
  <div id="drop4"></div>
</div>

<i class="spin fa fa-spinner fa-pulse"></i>
<script>

const Trans = [
['ья', '(ya|ia|iya)'],
['ье', '(ie|e|ye)'],
['ьи', '(yi|i)'],
['ай', '(ay|ai)'],
['ой', '(oy|oi)'],
['ий', '(iy|ii)'],
['уй', '(uy|ui)'],
['ый', '(yy|yi)'],
['эй', '(ey|yey)'],
['юй', '(yuy|yui)'],
['ей', '(ey|yey|ei)'],
['ия', '(ia|iya|ya)'],

['а','a'],['б','b'],['в','v'],['г','g'],['д','d'],
['е','e'],['ё','e'],['ж','zh'],['з','z'],['и','i'],
['й','i'],['к','k'],['л','l'],['м','m'],['н','n'],
['о','o'],['п','p'],['р','r'],['с','s'],['т','t'],
['у','u'],['ф','f'],['х','kh'],['ц','ts'],['ч','ch'],
['ш','sh'],['щ','shsh'],['ъ','ie'],['ы','y'],['ь',''],
['э','e'],['ю','yu'],['я','ya']
];

    const Cyr = document.getElementById("cyr"),
          Lat = document.getElementById("lat"),
          unMatch = document.getElementById("unMatch");
    
    var _show = false, _srtPrfm = true, _unique = false;

function notEmpty(ob) { return /\S/mg.test(ob.value); }

var menuPos = 1;
function initPos(newPos) {
    const   pnl = document.querySelector(".fix_panel"),
            Bdy = document.querySelector('.txt_area');
    
    pnl.classList.remove(`panel${menuPos}`);
    Bdy.classList.remove(`area${menuPos}`);
    if(newPos) menuPos = newPos;
    else menuPos = menuPos < 4 ? menuPos+1 : 1;
    pnl.classList.add(`panel${menuPos}`);
    Bdy.classList.add(`area${menuPos}`);
}

function clearData() {
  Cyr.value = '';
  Lat.value = '';
  unMatch.value = '';
  setSortIcon();
}

function sampleData(tip) {
  Cyr.value = document.getElementById("pre_cyr").innerText.trim().split('\n').map(e => {
      if(tip==0) return e.split(' ')[0];
      if(tip==1) return e;
      return `${(e=e.split(' '))[2].toUpperCase()} ${e[0]} ${e[1]}`;
  }).join('\n');
  Lat.value = document.getElementById("pre_lat").innerText.trim().split('\n').map(e => {
      if(tip==0) return e.split(' ')[0];
      if(tip==1) return e;
      return `${(e=e.split(' '))[2].toUpperCase()} ${e[0]} ${e[1]}`;
  }).join('\n');
  unMatch.value = '';
  setSortIcon();
  matchTrans();
}

function showNumber(fl) {
  let st = document.querySelector('.showNumber').style;
  st.top = (fl && st.top != '200px')?'200px':'-300px';
}
function getNumber() {
	let v = document.getElementById('numNames').value;
    showNumber(false);
    if(isNaN(v) || parseInt(v,10) < 1) preToggleToast('WRONG',600);
    else bigDataSim(parseInt(v,10));
}

function bigDataSim(Qt) {
    if(Qt < 300) preToggleToast(`${Qt} rcs`,800);
    let Cr = document.getElementById("pre_cyr").innerText.trim().split('\n'),
        Lt = document.getElementById("pre_lat").innerText.trim().split('\n');
    let CR = [], LT = [], L = Math.min(Cr.length,Lt.length);
    
    while(Qt > 0) {
        CR = CR.concat(Cr.slice(0, Math.min(L,Qt)));
        LT = LT.concat(Lt.slice(0, Math.min(L,Qt)));
        Qt -= L;
    }
    Cyr.value = CR.join('\n');
    Lat.value = LT.join('\n');
    unMatch.value = '';
    setSortIcon();
    matchTrans();
}

function showMatch() {
    _show = !_show;
    preToggleToast(`Show ${_show?'ON':'OFF'}`,800);
    matchTrans();
}

function matchTrans(_sort = false) {
    /*let cr = Cyr.value.trim(), lt = Lat.value.trim(); // empty
    if(cr == '' || lt == '') { preToggleToast('EMPTY',600); return; }*/
    if(!notEmpty(Cyr) || !notEmpty(Lat)) { preToggleToast('EMPTY',600, true); return; }
    if((Cyr.value.match(/\n/mg) || []).length > 300) {
        spinOn(true);
        setTimeout(()=>{ matchProc(_sort,true); },0);
    }
    else matchProc(_sort,false);
}

function matchProc(_sort = false, _spin) {
try {
    let cr = Cyr.value.trim(), lt = Lat.value.trim();
    if(cr == '' || lt == '') { preToggleToast('EMPTY',600, true); return; }

	let RxD = / → .+/gm;
    if(RxD.test(cr)) cr = cr.replace(RxD,'');
    if(cr.includes(" \n")) cr = cr.replace(/ +$/gm,'');
    if(RxD.test(lt)) lt = lt.replace(RxD,'');
    if(lt.includes(" \n")) lt = lt.replace(/ +$/gm,'');

    let cyr = cr.split('\n'),
        lat = lt.split('\n');

        lat = lat.map(el => el.trim());
    
    if(_unique) { cyr = [...new Set(cyr)]; lat = [...new Set(lat)]; }
    
    if(_sort) {
        if(_srtPrfm) { cyr.sort(); lat.sort(); _srtPrfm = false; }
        else {
            cyr.reverse(); lat.reverse();
            let i = document.getElementById("sortIcon").classList;
            i.toggle('fa-sort-alpha-asc'); i.toggle('fa-sort-alpha-desc');
        }
    }

    for(let i in cyr) {
      
      let w = cyr[i].trim().toLowerCase(); if(w == '') continue;
      if(w.charAt(0) == 'е' || w.charAt(0) == 'ё') w = "(ye|e)" + w.slice(1);
      let Rx = / (е|ё)/ig;
      if(Rx.test(w)) w = w.replace(Rx," (ye|e)");
      
      Trans.forEach(lit => { w = w.replaceAll(lit[0],lit[1]); });
      
      Rx = new RegExp('^'+ w + '$','i');

      let ix = lat.findIndex(val => Rx.test(val));
      if(ix < 0) cyr[i] += ' → ?';
      else {
          if(_show) cyr[i] += ' → ' + lat[ix];
          lat[ix] = '+' + lat[ix];
      }
    }

    Cyr.value = cyr.join('\n');
    lat = lat.map(el => (el.charAt(0)=='+'?el.slice(1):el+' → ?'));
    Lat.value = lat.join('\n');
    
    unMatch.style.backgroundColor = themeBk[themeCnt];
    setTimeout(()=>{ unMatch.style.backgroundColor = ''; }, 400);
    
    Rx = / → \?$/;
    cr = cyr.filter(e=>Rx.test(e));
    lt = lat.filter(e=>Rx.test(e));
    unMatch.value  = `⚑ MISMATCHED (${cr.length}/${cyr.length} Cyrillic):\n\n${cr.join('\n')}\n\n⚑ MISMATCHED (${lt.length}/${lat.length} Transliterated):\n\n${lt.join('\n')}`;
    if(_spin) spinOn(false);

} catch(e) { alert("ERROR: " + e.message); }
}

function moreInfo(fl) {
    let el = document.querySelector('.infoPad');
    if(fl) {
      let Ar = Trans.map(e => e.join(' → '));
      el.querySelector('code').innerText = Ar.filter(e=>e.includes('|')).join('\n') +  '\n\n' + Ar.filter(e=>!e.includes('|')).join(', ');
      el.style.top = '0px';
    }
    else el.style.top = '-100vh';
}

function spinOn(fl) {
    let s = document.querySelector('.spin').style;
    s.display = fl?'block':'none';
}

function preToggleToast(txt, ms, bg = false) {
	let T = document.querySelector('.pregToast');
	if(ms) {
	    T.querySelector('span').innerText = txt;
	    T.style.top = '120px';
	    setTimeout( ()=>{ preToggleToast(null, 0); }, ms);
	    if(bg) alterSVGbg('.bk', 'backgroundImage', false);
	}
	else T.style.top = '-60px';
}

document.querySelector('.fix_panel').querySelectorAll('div').forEach(e => e.addEventListener("click", function(e) {
    let el = e.target.tagName != 'div' ? e.target.parentElement : e.target;
    el.classList.remove("pulse");
    void el.offsetWidth;
    el.classList.add("pulse");
    //navigator.vibrate(100);
}, false));

function setInp() {
    unMatch.value = '';
    setSortIcon();
    //if(Cyr.value.trim() !='' && Lat.value.trim() !='') {
    if(notEmpty(Cyr) && notEmpty(Lat)) {
        const rusPat = /[а-я]/mgi;
        if(!rusPat.test(Cyr.value)) { preToggleToast('Not Cyrillic',600, true); Cyr.value = ''; return; }
        if(rusPat.test(Lat.value)) { preToggleToast('Not Latin',600, true); Lat.value = ''; return; }
        matchTrans();
    }
}
Cyr.addEventListener('input', setInp);
Lat.addEventListener('input', setInp);

function setSortIcon() {
    _srtPrfm = true;
    let i = document.getElementById("sortIcon").classList;
    i.remove('fa-sort-alpha-asc','fa-sort-alpha-desc');
    i.add('fa-sort-alpha-asc');
}

function uniqueSet(el) {
    const sp = el.querySelector('label');
    _unique = !_unique; //sp.slice(-3) == 'OFF'?true:false;
    sp.innerHTML = `Uniques<br>Set ${_unique?'ON':'OFF'}`;
    preToggleToast(`Unique ${_unique?'ON':'OFF'}`,800);
}

var duoCurr = 1;
function duotone() {
    let old = duoCurr;
    duoCurr =  duoCurr < 4 ? duoCurr+1 : 1;
    document.querySelector(".fix_panel").querySelectorAll('div').forEach(e => {
        e.classList.remove(`font${old}`);
        e.classList.add(`font${duoCurr}`);
    });
}

var wRepl = [];
function norm(av, cf, mn) {
	for(let i in av)
    	av[i] = Math.min( Math.floor( parseInt(av[i],16)*cf ), mn).toString(16);
    if(mn>100) for(let i in av) av[i] = ('0'+av[i]).slice(-2);
	return `'%23${av[0]}${av[1]}${av[2]}'`;
}
function alterSVGbg(rule, slctr, rcvr) {
try {
    const   sh = document.styleSheets[1],
            r = [...(sh.cssRules || sh.rules)].find(e => e.selectorText == rule);
    if(!r) return;
    let s = r.style[slctr];
    if(wRepl.length < 1) {
        let x = s.match(/'%23(.+?)'/g);
        if(x) x.forEach(e => wRepl.push(e));
    }
    let rc = 0, cf = 1.4;
    s = s.replace(/'%23(.+?)'/g, e => {
        if(rcvr) return wRepl[rc++];
        let cl = e.slice(4,e.length-1),r,g,b;
        if(cl.length == 3) return norm([cl.charAt(0), cl.charAt(1), cl.charAt(2)], cf, 15);
        else return norm([cl.substr(0,2), cl.substr(2,2), cl.substr(4,2)], cf, 255);
    });
    r.style[slctr] = s;
    if(!rcvr) setTimeout(()=>{ alterSVGbg(rule, slctr, true); }, 600);
} catch(e) { return; }
}

var themeBk = ['#445','#44c','#484','#900','#909'], themeCnt = 0;
function chTheme() {
    themeCnt =  themeCnt < 4 ? themeCnt+1 : 0;
    wRepl = [];
    document.getElementById('curStyle').href = `translit_${themeCnt+1}.css`;
}

const scene = {
    sceneIx: 0, times: 0, intervalIx: 0,
    scenes: ['sampleData(1)', 1, 'matchTrans(true)', 1, 'initPos(0)', 4, 'showNumber(true)', 1, 'duotone()', 4, 'chTheme()', 1, 'duotone()', 4, 'chTheme()', 1, 'duotone()', 4, 'chTheme()', 1, 'duotone()', 4, 'chTheme()', 1, 'duotone()', 4, 'chTheme()', 1,'showNumber(false)', 1, 'clearData()', 1]
}

function toScene(fl, act = false) {
    const   e = document.querySelector('.scene'),
            i = e.querySelector('i');
    if(fl) {
        if(i.style.color == 'red') return;
        e.style.display = 'block';
        i.style.color = 'red';
        scene.sceneIx = 0; scene.times = 0;
        Function( scene.scenes[0] )();
        scene.intervalIx = setInterval(()=>{
            scene.times++;
            if(scene.times == scene.scenes[scene.sceneIx+1]) {
                scene.times = 0;
                scene.sceneIx += 2;
                if(scene.sceneIx >= scene.scenes.length) toScene(false);
            }
            Function( scene.scenes[scene.sceneIx] )();
        }, 1000);
    }
    else {
        if(act && i.style.color == 'red') return;
        i.style.color = '';
        e.style.display = 'none';
        if(scene.intervalIx) clearInterval(scene.intervalIx);
    }
}

function toSite(site) { document.location.href = site; }

setTimeout(()=>{ toScene(false, true); }, 5000);

/*-------------------------- Drag ------------------------------*/

const smRed = document.querySelector('#smRed'),
  dshRct = document.querySelector('#dshRct');
var offset = [0,0], isDown = false, isTouch;

function drop(evt) {
  evt.preventDefault();
  initPos(evt.target.id.slice(-1));
}
function _over(evt) {
  evt.preventDefault();
  evt.target.style.backgroundColor = 'rgba(200,0,0,.3)';
}
function _leave(evt) {
  evt.preventDefault();
  evt.target.style.backgroundColor = null;
}
function startDrag(e) {
  smRed.style.backgroundColor = '#f00';
  dshRct.style.display = 'block';
  if(e.touches) {
    isDown = true;
    e = e.touches[0];
    offset = [ smRed.offsetLeft - e.clientX, smRed.offsetTop - e.clientY ];
    navigator.vibrate(60);
  }
}
function endDrag(e) {
try {
  smRed.style.backgroundColor = '';
  dshRct.style.display = 'none';
  isDown = false;
  if(e.touches) {
    e = e.touches[0];
    let dx = e.clientX, dy = e.clientY;
    let el = document.elementFromPoint(dx, dy);
    alert(el.id);
  }
} catch(err) { alert(err.message); }
}

function dragTouch(e) {
try {
  if(!isDown) return;
  e.preventDefault();
  
  e = e.touches[0];
  let dx = e.clientX, dy = e.clientY;
  
  smRed.style.left = `${dx + offset[0]}px`;
  smRed.style.top  = `${dy + offset[1]}px`;

  let el = document.elementFromPoint(dx, dy);
  if(['drop1', 'drop2', 'drop3', 'drop4'].includes(el.id))
    el.style.backgroundColor = 'rgba(200,0,0,.2)';

} catch(err) { alert(err.message); }
}

function init() {
  isTouch = ('ontouchstart' in window) || (navigator.msMaxTouchPoints > 0);
  //window.addEventListener('resize', ()=>{ drawGraph(quoAng); });
try {
  if(isTouch) {
    smRed.addEventListener('touchstart', startDrag, true);
    document.addEventListener('touchmove', dragTouch, true);
    document.addEventListener('touchend', endDrag, true);
    //document.addEventListener('touchleave', endDrag, true);
    //document.addEventListener('touchcancel', endDrag, true);
    dshRct.querySelectorAll('div').forEach(e => {
      e.addEventListener('drop', drop);
      e.addEventListener('dragover', _over);
      e.addEventListener('dragleave', _leave);
    });
  }
  else {
    smRed.addEventListener('dragstart', startDrag);
    smRed.addEventListener('dragend', endDrag);
    dshRct.querySelectorAll('div').forEach(e => {
      e.addEventListener('drop', drop);
      e.addEventListener('dragover', _over);
      e.addEventListener('dragleave', _leave);
    });
  }
} catch(err) { alert(err.message); }
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
